<!DOCTYPE html>
<!--
	Demonstration of the TI SensorTag JavaScript library.
	Modified to connect with the HANA Cloud Platform

	Date: 10/7/2015
-->
<html>

<head>
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta http-equiv="cache-control" content="no-store" />
	<link rel="stylesheet" type="text/css" href="../css/iotDashboard.css" />
	<link rel="stylesheet" type="text/css" href="css/myCss.css" />	
	<link type="text/css" rel="stylesheet" href="../css/site.css" />
	<link type="text/css" rel="stylesheet" href="../css/style.css" />
	<link type="text/css" rel="stylesheet" href="../css/sensortag.css" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    </style>
	<title>TI SensorTag 2.0 Sensors</title>
	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>
	<script src="cordova.js"></script>
	<script src="libs/jquery/jquery.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
	<script>
	var currentDevice = {};
	var bRemote = document.URL.substr(0,3) == 'http';
	var currentTemperature = 0;
	var currentIRTemperature = 0;
	var currentHumidity = 0;
	var currentPressure = 0;
	var currentVibration = 0;
	// SensorTag object.
	var sensortag = evothings.tisensortag.createInstance()
	var messagesSent = 0;
	var deviceCount = 0;
	var firmware;

	sensortag.lightCount = 0;
	sensortag.button1Count = 0;
	sensortag.button2Count = 0;
	sensortag.tempCount = 0;
	sensortag.humidityCount = 0;
	sensortag.accelerometerCount = 0;
	sensortag.gyroscopeCount = 0;
	sensortag.barometerCount = 0;
    window.humidityFinal = 0;
    window.temperatureFinal = 0;
    window.luxFinal = 0;
    window.pressureFinal = 0;
    window.magnetometerXFinal = 0;
    window.magnetometerYFinal = 0;
    window.magnetometerZFinal = 0;
    window.accelerometerXFinal = 0;
    window.accelerometerYFinal = 0;
    window.accelerometerZFinal = 0;
    window.gyroscopeXFinal = 0; 
    window.gyroscopeYFinal = 0; 
    window.gyroscopeZFinal = 0; 
	function init() {

	}

	function updateStatus() {
		console.log('updating status');
		displayValue('BridgeStatusData', 'SensorTag to HCP');
	}

        function initialiseSensorTag()
	{
		//
		// Here sensors are set up.
		//
		// If you wish to use only one or a few sensors, just set up
		// the ones you wish to use.
		//
		// First parameter to sensor function is the callback function.
		// Several of the sensors take a millisecond update interval
		// as the second parameter.
		// Gyroscope takes the axes to enable as the third parameter:
		// 1 to enable X axis only, 2 to enable Y axis only, 3 = X and Y,
		// 4 = Z only, 5 = X and Z, 6 = Y and Z, 7 = X, Y and Z.
		//
		var movementConfigVal = 60;
//		connect();
		sensortag
			.statusCallback(statusHandler)
			.errorCallback(errorHandler)
			.keypressCallback(keypressHandler)
			.irTemperatureCallback(irTemperatureHandler, 5000)
			.humidityCallback(humidityHandler,20000)
			.barometerCallback(barometerHandler, 50000)
			.luxometerCallback(luxometerHandler, 1000)
			.connectToClosestDevice()

        var options = { timeout: 30000 };
    	console.log(JSON.stringify(evothings));
    	console.log(JSON.stringify(device));


	}

	function statusHandler(status)
	{
		displayValue('SensorsNearbyData', 'There are ' + Object.keys(sensortag.devicesFound).length + ' sensors nearby.')
		deviceCount = 0;
		if ('Device data available' == status)
		{

			console.log('about to updatestats.  device = ' + JSON.stringify(sensortag.device));
			updateStatus();
			console.log('currentDevice = ' + JSON.stringify(currentDevice));
    		displayValue('DeviceName',currentDevice.deviceName + " connected " + currentDevice.connectionCount + " times.");
			var fw = sensortag.getFirmwareString();
//			alert(sensortag.device.address);
			var status = sensortag.device.address + ' ' + fw;
			if (firmware < 1.2) {
				status = firmware + " You are running an old firmware version.  You can continue to use this, but please upgrade to v1.20 soon.  This can be done by using the TI app.";
				sensortag.movementCallback([accelerometerHandler,gyroscopeHandler,magnetometerHandler], 100, 254);
			} else {
	 			sensortag.movementCallback([accelerometerHandler,gyroscopeHandler,magnetometerHandler], 100, 255);
			}
			displayValue('DeviceData', status)
			pushToHCP("firmware",fw,"version");
		}
		displayValue('StatusData', status)
	}

	function errorHandler(error)
	{
		console.log('Error: ' + error)
		if ('disconnected' == error)
		{
			// Clear current values.
			var blank = '[Waiting for value]'
			displayValue('StatusData', 'Ready to connect')
			displayValue('DeviceData', '?')
//			displayValue('KeypressData', blank)
			displayValue('IRTemperatureData', blank)
			displayValue('AccelerometerData', blank)
			displayValue('HumidityData', blank)
			displayValue('MagnetometerData', blank)
			displayValue('BarometerData', blank)
			displayValue('GyroscopeData', blank)

			// Reset screen color.
			setBackgroundColor('white')

			// If disconneted attempt to connect again.
			setTimeout(
				function() { sensortag.connectToClosestDevice()
					sensortag.lightCount = 0;
					sensortag.buttonCount = 0;
					sensortag.tempCount = 0;
					sensortag.humidityCount = 0;
					sensortag.accelerometerCount = 0;
					sensortag.gyroscopeCount = 0;
					sensortag.barometerCount = 0;


			},
				1000)
		}
	}

	// calculations implemented as based on TI wiki pages
	// http://processors.wiki.ti.com/index.php/SensorTag_User_Guide

	function keypressHandler(data)
	{
		// Update background color.
		switch (data[0])
		{
			case 0:
				setBackgroundColor('white')
				break;
			case 1:
				setBackgroundColor('red')
				var string = 'Count = ' + ++sensortag.button1Count;
				pushToHCP('button1',sensortag.button1Count,'count');
                window.button1CoutTotal ++;
				displayValue('Keypress1Data', string)
				break;
			case 2:
				setBackgroundColor('blue')
				var string = 'Count = ' + ++sensortag.button2Count;
				pushToHCP('button2',sensortag.button2Count,'count');
				displayValue('Keypress2Data', string)
				break;
			case 3:
				setBackgroundColor('magenta')
				break;
		}

		// Update the value displayed.
		var string = 'raw: 0x' + bufferToHexStr(data, 0, 1) + ' Count = ' + ++sensortag.buttonCount;
		displayValue('KeypressData', string)
	}

	function irTemperatureHandler(data)
	{
		// Calculate temperature from raw sensor data.
		var values = sensortag.getTemperatureValues(data)
		var ac = values.ambientTemperature
		var af = sensortag.celsiusToFahrenheit(ac)
		var tc = values.targetTemperature
		var tf = sensortag.celsiusToFahrenheit(tc)

		// Prepare the information to display.
		var string = ''
//			'raw: 0x' + bufferToHexStr(data, 0, 4) + '<br/>'
			+ (tc >= 0 ? '+' : '') + tc.toFixed(2) + '&deg; C '
			+ '(' + (tf >= 0 ? '+' : '') + tf.toFixed(2) + '&deg; F)' + '<br/>'
			+ (ac >= 0 ? '+' : '') + ac.toFixed(2) + '&deg; C '
			+ '(' + (af >= 0 ? '+' : '') + af.toFixed(2) + '&deg; F) [amb]' + '<br/>'
			+ 'Count = ' + ++sensortag.tempCount + '<br/>'

		if (currentDevice.deviceName == "") {
			currentDevice.deviceName = sensortag.device.address;
			displayValue('DeviceName',currentDevice.deviceName + " connected " + currentDevice.connectionCount + " times.");
		}
		pushToHCP('temperature',parseFloat(af.toFixed(2)),'F');
		pushToHCP('irtemperature',parseFloat(tf.toFixed(2)),'F');
		// Update the value displayed.
        window.temperatureFinal = tc;
		displayValue('IRTemperatureData', string)
	}

	function accelerometerHandler(data)
	{
		// Calculate the x,y,z accelerometer values from raw data.
//		var values = sensortag.getAccelerometerValues(data)
		var values = sensortag.getModelTwoAccelerometerValues(data)
		var x = values.x
		var y = values.y
		var z = values.z
        window.accelerometerXFinal = x;
        window.accelerometerYFinal = y;
        window.accelerometerZFinal = z;
		// Prepare the information to display.
		string = ''
//			'raw: 0x' + bufferToHexStr(data, 0, 6) + '<br/>'
			+ 'x = ' + (x >= 0 ? '+' : '') + x.toFixed(2) + '<br/>'
			+ 'y = ' + (y >= 0 ? '+' : '') + y.toFixed(2) + '<br/>'
			+ 'z = ' + (z >= 0 ? '+' : '') + z.toFixed(2) + '<br/>'
		string +=	'Count = ' + ++sensortag.accelerometerCount

		pushToHCP('maccelerationx',parseFloat(x.toFixed(2)),'g');
		pushToHCP('maccelerationy',parseFloat(y.toFixed(2)),'g');
		pushToHCP('maccelerationz',parseFloat(z.toFixed(2)),'g');
		var v = Math.abs((x / 2048) * 100);
		pushToHCP('movement',parseFloat(v.toFixed(2)),'g');
		// Update the value displayed.
		displayValue('AccelerometerData', string)
	}

	function humidityHandler(data)
	{
		// Calculate the humidity values from raw data.
		var values = sensortag.getHumidityValues(data)
		// Calculate the humidity temperature (C and F).
		var tc = values.humidityTemperature
		var tf = sensortag.celsiusToFahrenheit(tc)

		// Calculate the relative humidity.
		var h = values.relativeHumidity
        window.humidityFinal = tc;
		h = h < 0?h*-1:h;

		// Prepare the information to display.
		string =
			'raw: 0x' + bufferToHexStr(data, 0, 4) + '<br/>'
			+ (tc >= 0 ? '+' : '') + tc.toFixed(2) + '&deg; C '
			+ '(' + (tf >= 0 ? '+' : '') + tf.toFixed(2) + '&deg; F)' + '<br/>'
			+ (h >= 0 ? '+' : '') + h.toFixed(2) + '% RH' + '<br/>'

		// Update the value displayed.
		displayValue('HumidityData', string);
		if (h != currentHumidity) {
			pushToHCP('humidity',parseFloat(h.toFixed(2)),'pct');
		}
		currentHumidity = h;
	}

	function magnetometerHandler(data)
	{
		// Calculate the magnetometer values from raw sensor data.
		var values = sensortag.getMagnetometerValues(data)
		var x = values.x
		var y = values.y
		var z = values.z
        window.magnetometerXFinal = x;
        window.magnetometerYFinal = y;
        window.magnetometerXZFinal = z;

		//var model = sensortag.getDeviceModel()
		//var dataOffset = (model == 2 ? 12 : 0)

		// Prepare the information to display.
		var string =
			//'raw: <span style="font-family: monospace;">0x' +
			//	bufferToHexStr(data, dataOffset, 6) + '</span><br/>' +
			'x: ' + (x >= 0 ? '+' : '') + x.toFixed(1) + '&micro;T <br/>' +
			'y: ' + (y >= 0 ? '+' : '') + y.toFixed(1) + '&micro;T <br/>' +
			'z: ' + (z >= 0 ? '+' : '') + z.toFixed(1) + '&micro;T <br/>'



		// Update the value displayed.
		displayValue('MagnetometerData', string);

		pushToHCP('magx',parseFloat(x.toFixed(1)),'µT');
		pushToHCP('magy',parseFloat(y.toFixed(1)),'µT');
		pushToHCP('magz',parseFloat(z.toFixed(1)),'µT');


	}

	function barometerHandler(data)
	{
		// Calculate pressure from raw sensor data.
		var values = sensortag.getBarometerValues(data)
		var pressure = values.pressure.toPrecision(4)
        window.pressureFinal = pressure;
		// Prepare the information to display.
		string =
			//'raw: <span style="font-family: monospace;">0x' +
			//	bufferToHexStr(data, 0, 4) + '</span><br/>' +
			'Pressure: ' + pressure + ' mbar<br/>'

		if (pressure != currentPressure) {
			pushToHCP('pressure',parseFloat(pressure),'mbar');
		}
		currentPressure = pressure;
		// Update the value displayed.
		displayValue('BarometerData', string)
	}

	function gyroscopeHandler(data)
	{
//		console.log('gyroHandler')
		// Calculate the gyroscope values from raw sensor data.
//		var values = sensortag.getGyroscopeValues(data)
		var values = sensortag.getModelTwoGyroscopeValues(data)
		var x = values.x
		var y = values.y
		var z = values.z
        window.gyroscopeXFinal = x; 
        window.gyroscopeYFinal = y; 
        window.gyroscopeZFinal = z; 
		// Prepare the information to display.
		string =
			''
			+ 'x = ' + (x >= 0 ? '+' : '') + x.toFixed(1) + '<br/>'
			+ 'y = ' + (y >= 0 ? '+' : '') + y.toFixed(1) + '<br/>'
			+ 'z = ' + (z >= 0 ? '+' : '') + z.toFixed(1) + '<br/>'
			+ 'Count = ' + ++sensortag.gyroscopeCount

		pushToHCP('rotx',parseFloat(x.toFixed(1)),'deg/sec');
		pushToHCP('roty',parseFloat(y.toFixed(1)),'deg/sec');
		pushToHCP('rotz',parseFloat(z.toFixed(1)),'deg/sec');

		// Update the value displayed.
		displayValue('GyroscopeData', string)
	}

	function luxometerHandler(data)
	{
		// Prepare the information to display.
		var string = data[1]/2 + " Count=" + ++sensortag.lightCount + '<br/>';
		// Update the value displayed.
        window.luxFinal = (data[1]/2);
		displayValue('LuxometerData', string )
		pushToHCP('light',data[1]/2,'pct');
	}

	function displayValue(elementId, value)
	{
//		console.log(elementId);
		if (document.getElementById(elementId) !== null) {
			document.getElementById(elementId).innerHTML = value
		}
	}

	function setBackgroundColor(color)
	{
		document.documentElement.style.background = color
		document.body.style.background = color
	}

	/**
	 * Convert byte buffer to hex string.
	 * @param buffer - an Uint8Array
	 * @param offset - byte offset
	 * @param numBytes - number of bytes to read
	 * @return string with hex representation of bytes
	 */
	function bufferToHexStr(buffer, offset, numBytes)
	{
		var hex = ''
		for (var i = 0; i < numBytes; ++i)
		{
			hex += byteToHexStr(buffer[offset + i])
		}
		return hex
	}

	/**
	 * Convert byte number to hex string.
	 */
	function byteToHexStr(d)
	{
		if (d < 0) { d = 0xFF + d + 1 }
		var hex = Number(d).toString(16)
		var padding = 2
		while (hex.length < padding)
		{
			hex = '0' + hex
		}
		return hex
	}


	function pushToHCP(param,value) {
		sendMessage(param,value);
//        alert(sensortag.deviceName);
		messagesSent++;
		displayValue('StatusData', "Sensor online. " + messagesSent + " messages sent.");
        
	}
	function sendMessage(param,value) {
		var msg = '{'
            + '"NAME":"' + param + '",'
            + '"VALUE":"' + value  + '"'
            + '}';
		 var settings = {
          "async": true,
          "crossDomain": true,
          "url": "https://gservice.cfapps.sap.hana.ondemand.com/devices/" + sensortag.device.address +"/postData",
          "method": "POST",
          "headers": {
            "content-type": "application/json",
            "cache-control": "no-cache"
//              sensortag.device.address
          },
          "data": JSON.stringify({"Humidity" : window.humidityFinal, "Temperature" : window.temperatureFinal, "Luxometer" : window.luxFinal, "Pressure": window.pressureFinal, "magnetometerX" : window.magnetometerXFinal, "magnetometerY" : window.magnetometerYFinal, "magnetometerZ" : window.magnetometerZFinal,    "accelerometerX" : window.accelerometerXFinal, "accelerometerY" : window.accelerometerYFinal,  "accelerometerZ" : window.accelerometerYFinal, "gyroscopeX" : window.gyroscopeXFinal,"gyroscopeY" : window.gyroscopeYFinal, "gyroscopeZ" : window.gyroscopeZFinal  })
        }
         
//         alert(sensortag.device.address);
        $.ajax(settings).success(function (response) {
          console.log(response);
//          alert(window.temperatureFinal);
        }).error(function(response){
        alert("fail");
//              alert(sensortag.tempCount.toString);
//            alert(sensortag.tempCount);
        
        });
    }

	function getURLParameter(name) {
		  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
	}
	$(document).ready(function(){
		init();
	});

	document.addEventListener(
		'deviceready',
        function() { evothings.scriptsLoaded(initialiseSensorTag) },
		false);

	function initialize() {
	}


	</script>
	</head>
<body class='pageDefault' onload='initialize();' >
	<div id="uiArea">		
			<!-- <header>
				<button class="menu" onclick=""><img src="ui/images/menu.svg" /></button>
			</header> -->
		<div class="container">
				<div class = "App-Bar">
						<div class="Sensor-Name">Sensor Tag Name</div>
						<div>On/Off</div>
				</div>
				
					<div class="row">
						<div class="column">
							<div>
								<img src="img/icons8-temperature-48.png">
							</div>
							<div>Temperature</div>
						</div>
						<div class="column">
								<div>
									<img src="img/icons8-light-on-48.png">
								</div>
								<div>Light</div>
						</div>
						<div class="column">
								<div>
									<img src="img/icons8-humidity-48.png">						
								</div>
								<div>Humidity</div>
						</div>
						<div class="column">
								<div>
									<img src="img/icons8-atmospheric-pressure-48.png">
								</div>
								<div>Atmospheric Pressure</div>
						</div>
				
					</div>
							
					<div class="row">
							<div class="column">
								<div>
									<img src="img/icons8-gyroscope-48.png">
								</div>
								<div>Gyroscope</div>
							</div>
							<div class="column">
									<div>
										<img src="img/icons8-speed-48.png">
									</div>
									<div>Accelerometer</div>
							</div>
							<div class="column">
									<div>
										<img src="img/icons8-magnet-48.png">
									</div>
									<div>Magnetometer</div>
							</div>
							<div class="column">
									<div>
										<img src="img/icons8-motion-sensor-48.png">
									</div>
									<div>Gyroscope</div>
							</div>
					
						</div>
		
		
					<div class="list">
						<div class="list-item">
							<div class="list-icon">
								<img src="img/icons8-temperature-48.png">						
							</div>
							<div class="list-item-details">
								<div>
									<span id="Temperature Data">[Waiting for value]</span>
									<div>Temperature</div>
								</div>
							</div>
						</div>

						<div class="list-item">
							<div class="list-icon">
								<img src="img/icons8-humidity-48.png">						
							</div>
							<div class="list-item-details">
								<div> 
									<span id="Humidity Data">[Waiting for value]</span>
									<div>Humidity</div>
								</div>
							</div>
						</div>

						<div class="list-item">
							<div class="list-icon">
								<img src="img/icons8-light-on-48.png">						
							</div>
							<div class="list-item-details">
								<div>
									<span id="Luxometer Data">[Waiting for value]</span>
									<div>Luxometer</div>
								</div>
							</div>
						</div>

						<div class="list-item">
							<div class="list-icon">
								<img src="img/icons8-atmospheric-pressure-48.png">					
							</div>
							<div class="list-item-details">
								<div>
									<span id="Barometer Data">[Waiting for value]</span>
									<div>Barometer</div>
								</div>
							</div>
						</div>

						<div class="list-item">
							<div class="list-icon">
								<img src="img/icons8-speed-48.png">						
							</div>
							<div class="list-item-details">
								<div>
									<span id="Accelerometer Data">[Waiting for value]</span>
									<div>Accelerometer</div>
								</div>
							</div>
						</div>

						<div class="list-item">
							<div class="list-icon">
								<img src="img/icons8-magnet-48.png">						
							</div>
							<div class="list-item-details">
								<div>
									<span id="Magnetometer Data">[Waiting for value]</span>
									<div>Magnetometer</div>
								</div>
							</div>
						</div>
						
						<div class="list-item">
							<div class="list-icon">
								<img src="img/icons8-gyroscope-48.png">						
							</div>
							<div class="list-item-details">
								<div>
									<span id="Gyroscope Data">[Waiting for value]</span>
									<div>Gyroscope</div>
								</div>
							</div>
						</div>

					</div>
				
		</div>
			
			<!-- <div>
			<h1>
				<strong>Bridge Function:</strong> <span id="BridgeStatusData">SensorTag to HCP</span><button onClick='location.reload();'>Restart Bridge</button>
			</h1>
			<p>
				<strong>Sensors Nearby:</strong> <span id="SensorsNearbyData"></span>
			</p>
			<p>
				<strong>Status:</strong> <span id="StatusData">Ready to connect</span>
			</p>
			<p>
				<strong>Device Info:</strong> <span id="DeviceData"></span>
			</p>
			</div>
		
			<h2>Temperature:</h2>
			<p>
				<span id="IRTemperatureData">[Waiting for value]</span>
			</p>
		
			<h2>Accelerometer:</h2>
			<p>
				<span id="AccelerometerData">[Waiting for value]</span>
			</p>
		
		
			<h2>Gyroscope:</h2>
			<p>
				<span id="GyroscopeData">[Waiting for value]</span>
			</p>
		
			<h2>Luxometer:</h2>
			<p>
				<span id="LuxometerData">[Waiting for value]</span>
			</p>
		
			<div>
			<h2>Humidity:</h2>
			<p>
				</span><span id="HumidityData">[Waiting for value]</span>
			</p>
		
			<h2>Magnetometer:</h2>
			<p>
				<span id="MagnetometerData">[Waiting for value]</span>
			</p>
		
			<h2>Barometer:</h2>
			<p>
				<span id="BarometerData">[Waiting for value]</span>
			</p>
			<h2>Buttons:</h2>
			<p>
				<strong>Big Button:</strong> <span id="Keypress1Data"></span>
			</p>
			<p>
				<strong>Little Button:</strong> <span id="Keypress2Data"></span>
			</p>
			</div> -->
		</body>
		
</html>
